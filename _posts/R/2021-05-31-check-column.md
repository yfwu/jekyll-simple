---
title: "最後一格非空欄位取值"
layout: post
category: R
---
前幾天幫老闆做了一份資料整理的工作。大概是說我有如下表格。情境假設如下四個個案，各自的疾病追蹤日（從發病日算起），例如第一個案例就只有一次追蹤，病發後一天。第四個個案追蹤了三次，第三次是病發後第六天。

```
   fd1  fd2  fd3
1    1
2    2    3
3    1    5
4    2    4    6
```

那當想知道最後每個病人追蹤多久，就需要取出「最後一個非空欄位」的值。

```
   fd1  fd2  fd3  fd_final
1    1                   1
2    2    3              3
3    1    5              5
4    2    4    6         6
```

程式碼如下：

``` R
data <- read_xlsx(...) # lib: readxl
columns <- names(data)[1:3][max.col(!is.na(data[1:3]), 'last')]
data$fd_final <- sapply(seq_along(columns),
                        FUN = function (x) data[[x, columns[x]]])
```

先找出最後一個非空的欄位的名字（column name），然後用 `sapply` 取得對應的值。中間都是序列化（vectorized）的操作。非常的方便！另外在幫主任處理這些資料的時候遇到幾個問題；主要是主任一開始給我一份「有追蹤過」的病患的「部分檔案」；給了主任程式碼後卻狂報錯。後來發現：

1. 資料欄位不能「為空」。主任的完整資料包含了 fresh case 跟追蹤過一次（有 `fd1`）。這樣的話會出錯。
2. 後來單獨跑在全部有 follow up 的病人，還是報錯。原來有一些留空空格人為填入了字串 `NA`。

所以，除了程式，還要考慮到資料清理的部分。另外還是覺得上面的程式碼維護性很差，果然還是得好好的學習 `tinyverse` 才是正解。